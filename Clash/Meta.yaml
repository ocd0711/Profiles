######### é”šç‚¹ start #######
# ç­–ç•¥ç»„ç›¸å…³
pr: &pr { type: select, proxies: [AutoTest, HK, TW, JP, US, SG, Bypass] }

prn: &prn { type: select, proxies: [Proxy, HK, TW, JP, US, SG, Bypass] }

prnp: &prnp { type: select, proxies: [US, Proxy, HK, TW, JP, SG, Bypass] }

prnd: &prnd { type: select, proxies: [Proxy, HK, TW, JP, US, SG] }

pre: &pre { type: select, proxies: [SG, TW, US, Emby] }

#è¿™é‡Œæ˜¯è®¢é˜…æ›´æ–°å’Œå»¶è¿Ÿæµ‹è¯•ç›¸å…³çš„
p:
  &p {
    type: http,
    interval: 3600,
    health-check:
      {
        enable: true,
        url: http://cp.cloudflare.com/generate_204,
        interval: 300,
      },
  }

######### é”šç‚¹ end #######

# url é‡Œå¡«å†™è‡ªå·±çš„è®¢é˜…,åç§°ä¸èƒ½é‡å¤
proxy-providers:
  provider1:
    <<: *p
    url: ""

ipv6: true
allow-lan: true
mixed-port: 7890
unified-delay: false
tcp-concurrent: true
external-controller: 127.0.0.1:9090
external-ui: ui
external-ui-url: "https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip"

geodata-mode: true
geox-url:
  geoip: "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat"
  geosite: "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat"
  mmdb: "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb"

find-process-mode: strict
global-client-fingerprint: chrome

profile:
  store-selected: true

sniffer:
  enable: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  skip-domain:
    - "Mijia Cloud"

tun:
  enable: true
  stack: mixed
  dns-hijack:
    - "any:53"
    - "tcp://any:53"
  auto-route: true
  auto-detect-interface: true

proxies:
  - name: "Bypass"
    type: direct
    udp: true
  - name: DNS_Hijack
    type: dns

proxy-groups:
  - { name: Proxy, <<: *pr }
  - { name: Final, type: select, proxies: [Proxy, Bypass] }
  - { name: CDN, type: select, proxies: [Proxy, Bypass] }
  - { name: Download, <<: *prn }
  - { name: Streaming, <<: *prnd }
  - { name: EmbyProxy, <<: *pre }
  - { name: AI, <<: *prnd }
  - { name: Telegram, <<: *prnd }
  - { name: Paypal, <<: *prnp }
  - { name: Speedtest, <<: *prn }
  - { name: Duolingo, <<: *prn }

  #åˆ†éš”,ä¸‹é¢æ˜¯åœ°åŒºåˆ†ç»„
  - {
      name: HK,
      type: url-test,
      include-all-providers: true,
      filter: "(?=.*(é¦™æ¸¯|HK|ğŸ‡­ğŸ‡°))^((?!(Gamer|emby)).)*$",
    }
  - {
      name: TW,
      type: url-test,
      include-all-providers: true,
      filter: "(?=.*(å°æ¹¾|TW|ğŸ‡¹ğŸ‡¼))^((?!(Gamer|emby)).)*$",
    }
  - {
      name: JP,
      type: url-test,
      include-all-providers: true,
      filter: "(?=.*(æ—¥æœ¬|JP|ğŸ‡¯ğŸ‡µ))^((?!(Gamer|emby)).)*$",
    }
  - {
      name: US,
      type: url-test,
      include-all-providers: true,
      filter: "(?=.*(ç¾å›½|US|ğŸ‡ºğŸ‡¸))^((?!(Gamer|emby)).)*$",
    }
  - {
      name: SG,
      type: url-test,
      include-all-providers: true,
      filter: "(?=.*(æ–°åŠ å¡|SG|ğŸ‡¸ğŸ‡¬))^((?!(Gamer|emby)).)*$",
    }
  - {
      name: Emby,
      type: url-test,
      include-all-providers: true,
      filter: "(?=.*(emby))^((?!(Gamer)).)*$",
    }
  - {
      name: AutoTest,
      type: url-test,
      include-all-providers: true,
      tolerance: 10,
      filter: "^((?!(Gamer|arm|emby)).)*$",
    }

rules:
  - DST-PORT,53,DNS_Hijack

  # # åŒ—ç¾ç›¸å…³æµåª’ä½“
  # - RULE-SET,stream_us_non_ip,Streaming
  # - RULE-SET,stream_us_ip,Streaming
  # # æ¬§æ´²ç›¸å…³æµåª’ä½“
  # - RULE-SET,stream_eu_non_ip,Streaming
  # - RULE-SET,stream_eu_ip,Streaming
  # # æ—¥æœ¬ç›¸å…³æµåª’ä½“
  # - RULE-SET,stream_jp_non_ip,Streaming
  # - RULE-SET,stream_jp_ip,Streaming
  # # éŸ©å›½ç›¸å…³æµåª’ä½“
  # - RULE-SET,stream_kr_non_ip,Streaming
  # - RULE-SET,stream_kr_ip,Streaming
  # # é¦™æ¸¯ç›¸å…³æµåª’ä½“
  # - RULE-SET,stream_hk_non_ip,Streaming
  # - RULE-SET,stream_hk_ip,Streaming
  # # å°æ¹¾ç›¸å…³æµåª’ä½“
  # - RULE-SET,stream_tw_non_ip,Streaming
  # - RULE-SET,stream_tw_ip,Streaming
  # æ‰€æœ‰æµåª’ä½“ï¼ˆåŒ…æ‹¬ä¸Šè¿°æ‰€æœ‰æµåª’ä½“ï¼‰
  - RULE-SET,stream_non_ip,Streaming
  - RULE-SET,stream_ip,Streaming

  # Emby æµåª’ä½“
  - RULE-SET,Emby,Emby

  # OpenAI
  - RULE-SET,ai_non_ip,AI
  - RULE-SET,apple_intelligence_non_ip,AI

  # Telegram åŠ é€Ÿ
  - RULE-SET,telegram_non_ip,Telegram
  - RULE-SET,telegram_ip,Telegram

  # Paypal åŠ é€Ÿ
  - RULE-SET,PayPal,Paypal

  # Speedtest åˆ†æµ
  - RULE-SET,speedtest,Speedtest

  # Duolingo åˆ†æµ
  - RULE-SET,duolingo,Duolingo

  # Apple CN
  - RULE-SET,apple_cn_non_ip,Bypass

  # Apple CDN
  - RULE-SET,apple_cdn,Bypass

  # Apple Services
  - RULE-SET,apple_services,Proxy

  # Microsoft CDN
  - RULE-SET,microsoft_cdn_non_ip,Bypass

  # è½¯ä»¶æ›´æ–°ã€æ“ä½œç³»ç»Ÿç­‰å¤§æ–‡ä»¶ä¸‹è½½
  - RULE-SET,download_domainset,Download
  - RULE-SET,download_non_ip,Download

  # å¸¸è§é™æ€ CDN
  - RULE-SET,cdn_domainset,Proxy
  - RULE-SET,cdn_non_ip,Proxy

  # Global å…¨çƒåŠ é€Ÿ
  - RULE-SET,global_non_ip,Proxy

  # China DIRECT
  - RULE-SET,domestic_non_ip,Bypass
  - RULE-SET,direct_non_ip,Bypass
  - RULE-SET,domestic_ip,Bypass
  - RULE-SET,BOC,Bypass
  - RULE-SET,china_ip,Bypass
  # Only use it if you are using IPv6
  # - RULE-SET,china_ip_ipv6,Bypass

  # Non IP
  - RULE-SET,lan_non_ip,Bypass
  # IP
  - RULE-SET,lan_ip,Bypass

  # GeoIP China
  - GEOIP,CN,Bypass

  - MATCH,Final

rule-anchor:
  classical_text:
    &classical_text {
      type: http,
      behavior: classical,
      format: text,
      interval: 43200,
    }
  domain_text:
    &domain_text {
      type: http,
      behavior: domain,
      format: text,
      interval: 43200,
    }
  ipcidr_text:
    &ipcidr_text {
      type: http,
      behavior: ipcidr,
      format: text,
      interval: 43200,
    }
  classical_default:
    &classical_default {
      type: http,
      behavior: classical,
      interval: 43200,
    }

rule-providers:
    # # åŒ—ç¾ç›¸å…³æµåª’ä½“
  # stream_us_non_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/non_ip/stream_us.txt
  #   path: ./RuleSet/stream_us_non_ip.txt
  # stream_us_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/ip/stream_us.txt
  #   path: ./RuleSet/stream_us_ip.txt
  # # æ¬§æ´²ç›¸å…³æµåª’ä½“
  # stream_eu_non_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/non_ip/stream_eu.txt
  #   path: ./RuleSet/stream_eu_non_ip.txt
  # stream_eu_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/ip/stream_eu.txt
  #   path: ./RuleSet/stream_eu_ip.txt
  # # æ—¥æœ¬ç›¸å…³æµåª’ä½“
  # stream_jp_non_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/non_ip/stream_jp.txt
  #   path: ./RuleSet/stream_jp_non_ip.txt
  # stream_jp_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/ip/stream_jp.txt
  #   path: ./RuleSet/stream_jp_ip.txt
  # # éŸ©å›½ç›¸å…³æµåª’ä½“
  # stream_kr_non_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/non_ip/stream_kr.txt
  #   path: ./RuleSet/stream_kr_non_ip.txt
  # stream_kr_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/ip/stream_kr.txt
  #   path: ./RuleSet/stream_kr_ip.txt
  # # é¦™æ¸¯ç›¸å…³æµåª’ä½“
  # stream_hk_non_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/non_ip/stream_hk.txt
  #   path: ./RuleSet/stream_hk_non_ip.txt
  # stream_hk_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/ip/stream_hk.txt
  #   path: ./RuleSet/stream_hk_ip.txt
  # # å°æ¹¾ç›¸å…³æµåª’ä½“
  # stream_tw_non_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/non_ip/stream_tw.txt
  #   path: ./RuleSet/stream_tw_non_ip.txt
  # stream_tw_ip:
  #   <<: *classical_text
  #   url: https://ruleset.skk.moe/Clash/ip/stream_tw.txt
  #   path: ./RuleSet/stream_tw_ip.txt
  # æ‰€æœ‰æµåª’ä½“ï¼ˆåŒ…æ‹¬ä¸Šè¿°æ‰€æœ‰æµåª’ä½“ï¼‰
  stream_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/stream.txt
    path: ./RuleSet/stream_non_ip.txt
  stream_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/ip/stream.txt
    path: ./RuleSet/stream_ip.txt

  # Telegram åŠ é€Ÿ
  telegram_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/telegram.txt
    path: ./RuleSet/telegram_non_ip.txt
  telegram_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/ip/telegram.txt
    path: ./RuleSet/telegram_ip.txt

  # BOC
  BOC:
    <<: *classical_default
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/BOC/BOC.yaml

  # Apple CN
  apple_cn_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/apple_cn.txt
    path: ./RuleSet/apple_cn_non_ip.txt

  # Apple Service
  apple_services:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/apple_services.txt
    path: ./RuleSet/apple_services.txt

  # Apple CDN
  apple_cdn:
    <<: *domain_text
    url: https://ruleset.skk.moe/Clash/domainset/apple_cdn.txt
    path: ./RuleSet/apple_cdn.txt

  # Microsoft CDN
  microsoft_cdn_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/microsoft_cdn.txt
    path: ./RuleSet/microsoft_cdn_non_ip.txt

  # Paypal åŠ é€Ÿ
  PayPal:
    <<: *classical_default
    path: ./RuleSet/PayPal.yaml
    url: https://raw.githubusercontent.com/dler-io/Rules/main/Clash/Provider/PayPal.yaml

  # å¤šé‚»å›½
  duolingo:
    <<: *classical_default
    path: ./RuleSet/duolingo.yaml
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Duolingo/Duolingo.yaml

  # è½¯ä»¶æ›´æ–°ã€æ“ä½œç³»ç»Ÿç­‰å¤§æ–‡ä»¶ä¸‹è½½
  download_domainset:
    <<: *domain_text
    url: https://ruleset.skk.moe/Clash/domainset/download.txt
    path: ./RuleSet/download_domainset.txt
  download_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/download.txt
    path: ./RuleSet/download_non_ip.txt

  # Speedtest æµ‹é€Ÿ
  speedtest:
    <<: *domain_text
    url: https://ruleset.skk.moe/Clash/domainset/speedtest.txt
    path: ./RuleSet/speedtest.txt

  # å¸¸è§é™æ€ CDN
  cdn_domainset:
    <<: *domain_text
    url: https://ruleset.skk.moe/Clash/domainset/cdn.txt
    path: ./RuleSet/cdn_domainset.txt
  cdn_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/cdn.txt
    path: ./RuleSet/cdn_non_ip.txt

  # å†…ç½‘åŸŸåå’Œå±€åŸŸç½‘ IP
  lan_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/lan.txt
    path: ./RuleSet/lan_non_ip.txt
  lan_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/ip/lan.txt
    path: ./RuleSet/lan_ip.txt

  # Emby æµåª’ä½“
  Emby:
    <<: *classical_default
    path: ./RuleSet/emby.yaml
    url: https://raw.githubusercontent.com/ocd0711/Profiles/master/Clash/Ruleset/emby-proxy.yaml

  # AI ç›¸å…³
  ai_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/ai.txt
    path: ./RuleSet/ai_non_ip.txt
  apple_intelligence_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/apple_intelligence.txt
    path: ./RuleSet/apple_intelligence_non_ip.txt

  # Misc
  domestic_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/domestic.txt
    path: ./RuleSet/domestic_non_ip.txt
  direct_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/direct.txt
    path: ./RuleSet/direct_non_ip.txt
  global_non_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/non_ip/global.txt
    path: ./RuleSet/global_non_ip.txt
  domestic_ip:
    <<: *classical_text
    url: https://ruleset.skk.moe/Clash/ip/domestic.txt
    path: ./RuleSet/domestic_ip.txt

  # chnroute CIDR
  china_ip:
    <<: *ipcidr_text
    url: https://ruleset.skk.moe/Clash/ip/china_ip.txt
    path: ./RuleSet/china_ip.txt
  china_ip_ipv6:
    <<: *ipcidr_text
    url: https://ruleset.skk.moe/Clash/ip/china_ip_ipv6.txt
    path: ./RuleSet/china_ipv6.txt